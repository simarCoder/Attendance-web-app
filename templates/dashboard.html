<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | HR System</title>

    <!-- CSS (Converted to Jinja2) -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/theme.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/layout.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/components.css') }}"
    />
  </head>
  <body>
    {% if demo_mode %}
    <div class="demo-banner">
      ‚ö†Ô∏è This software is for demo purposes only. It will work for 3 days.
      Contact for further extension.
    </div>
    {% endif %}

    <!-- FLOATING THEME TOGGLE (Desktop) -->
    <button
      id="desktop-theme-toggle"
      class="theme-toggle-btn desktop-only"
      onclick="toggleTheme()"
      aria-label="Toggle Theme"
    >
      <svg
        class="icon-sun"
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="5" />
        <path
          d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
        />
      </svg>
      <svg
        class="icon-moon"
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>

    <!-- MOBILE HEADER -->
    <header class="mobile-header">
      <button class="btn-icon" onclick="toggleSidebar()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <span class="mobile-brand">Operon HR</span>
      <button class="btn-icon" onclick="toggleTheme()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="5" />
          <path
            d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
          />
        </svg>
      </button>
    </header>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- TOAST & MODAL -->
    <div id="toast-container"></div>
    <div id="custom-modal" class="modal-overlay">
      <div class="modal-card">
        <h3 style="margin-bottom: 0.5rem">Confirmation</h3>
        <p id="modal-message" style="color: var(--text-muted)">Are you sure?</p>
        <div class="modal-actions">
          <button
            class="btn"
            style="background: var(--bg-input); color: var(--text-main)"
            onclick="closeConfirmModal()"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="handleConfirmYes()">
            Yes, Proceed
          </button>
        </div>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <!-- Branding -->
          <span>OPERON HR</span>
          <button class="btn-icon mobile-only" onclick="toggleSidebar()">
            ‚úï
          </button>
        </div>

        <nav class="sidebar-nav">
          <div
            class="nav-item active"
            onclick="switchSection('overview', this)"
          >
            <span>Dashboard</span>
          </div>
          <div class="nav-item" onclick="switchSection('employees', this)">
            <span>Employees</span>
          </div>
          <div class="nav-item" onclick="switchSection('attendance', this)">
            <span>Attendance</span>
          </div>
          <div class="nav-item" onclick="switchSection('salary', this)">
            <span>Salary</span>
          </div>
          <div class="nav-item" onclick="openEmployeeDetailsSection(this)">
            <span>Employee Details</span>
          </div>

          <!-- SETTINGS (Hidden for Users) -->
          <div
            class="nav-item special-access-only"
            style="display: none"
            onclick="switchSection('settings', this)"
          >
            <span>Settings</span>
          </div>

          <div class="nav-item nav-item-logout" onclick="logout()">
            <span>Logout</span>
          </div>

          <!-- Exit Application Item -->
          <div
            class="nav-item"
            onclick="exitApplication()"
            style="
              color: #ff4d4d;
              border-top: 1px solid var(--border);
              margin-top: 1rem;
              padding-top: 1rem;
              cursor: pointer;
            "
          >
            <span>üö™ Exit Application</span>
          </div>
        </nav>

        <!-- Sidebar Footer (CONTACT INFO) -->
        <div
          class="sidebar-footer"
          style="
            padding: 1.5rem 1rem;
            text-align: center;
            border-top: 1px solid var(--border);
          "
        >
          <!-- Operon Branding -->
          <div
            style="
              margin-bottom: 1rem;
              display: flex;
              flex-direction: column;
              align-items: center;
            "
          >
            <img
              src="{{ url_for('static', filename='operon.png') }}"
              alt="Operon"
              style="
                width: 36px;
                height: auto;
                opacity: 0.9;
                margin-bottom: 0.5rem;
              "
            />
            <p
              style="
                font-size: 0.75rem;
                color: var(--text-main);
                font-weight: 700;
                letter-spacing: 0.05em;
              "
            >
              OPERON SOFTWARE
            </p>
          </div>

          <!-- WhatsApp Button -->
          <a
            href="https://wa.me/919878519609?text=Hi%2C%20I%20need%20support%20with%20the%20HR%20System."
            target="_blank"
            class="btn"
            style="
              background-color: #25d366;
              color: white;
              width: 100%;
              text-decoration: none;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 0.5rem;
              font-size: 0.8rem;
              padding: 0.5rem;
              border-radius: 8px;
            "
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              fill="currentColor"
              viewBox="0 0 16 16"
            >
              <path
                d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592z"
              />
            </svg>
            Contact Support
          </a>

          <p
            style="
              font-size: 0.65rem;
              color: var(--text-muted);
              margin-top: 1rem;
            "
          >
            &copy; 2025 Operon.<br />All Rights Reserved.
          </p>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- 1. OVERVIEW -->
        <section id="overview" class="section active">
          <div class="content-header">
            <div>
              <h2>Overview</h2>
              <p>Welcome back, <span id="user-role-display">User</span>.</p>
            </div>
          </div>
          <!-- Stats -->
          <div class="stats-grid">
            <div class="card stat-card">
              <h3>Total Employees</h3>
              <div class="value" id="stat-total-emp">-</div>
            </div>
            <div class="card stat-card">
              <h3>Today's Date</h3>
              <div class="value" style="font-size: 1.25rem" id="stat-date">
                Loading...
              </div>
            </div>
            <div class="card stat-card">
              <h3>System Status</h3>
              <div
                class="value"
                style="color: var(--success); font-size: 1.25rem"
              >
                Online
              </div>
            </div>
          </div>
        </section>

        <!-- 2. EMPLOYEES -->
        <section id="employees" class="section">
          <div class="content-header">
            <h2>Employee Management</h2>
            <p>Add and view staff details.</p>
          </div>

          <div class="section-stack">
            <!-- Add Form (Top) -->
            <div class="card">
              <h3>Add New Employee</h3>
              <form
                id="add-employee-form"
                onsubmit="addEmployee(event)"
                style="margin-top: 0.5rem"
              >
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 0.75rem;
                  "
                >
                  <input
                    type="text"
                    id="emp-name"
                    class="form-control minimal-input"
                    placeholder="Full Name"
                    required
                  />
                  <input
                    type="text"
                    id="emp-role"
                    class="form-control minimal-input"
                    placeholder="Role / Designation"
                    required
                  />
                  <input
                    type="text"
                    id="emp-contact"
                    class="form-control minimal-input"
                    placeholder="Phone Number"
                    required
                  />
                  <input
                    type="text"
                    id="emp-address"
                    class="form-control minimal-input"
                    placeholder="Address"
                    required
                  />
                </div>
                <div
                  style="
                    margin-top: 0.75rem;
                    display: flex;
                    gap: 0.75rem;
                    align-items: center;
                  "
                >
                  <input
                    type="number"
                    id="emp-salary"
                    class="form-control minimal-input"
                    placeholder="Monthly Salary "
                    required
                    style="flex: 1"
                  />
                  <button
                    type="submit"
                    class="btn btn-primary"
                    style="min-width: 120px; padding: 0.5rem 1rem"
                  >
                    Add
                  </button>
                </div>
              </form>
            </div>

            <!-- List Table (Bottom) -->
            <div class="card table-container">
              <h3>Employee Directory</h3>
              <table class="table" style="margin-top: 1rem">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Salary</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="employee-table-body">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 3. ATTENDANCE -->
        <section id="attendance" class="section">
          <div class="content-header">
            <h2>Attendance Tracking</h2>
          </div>

          <div class="section-stack">
            <!-- 1. Individual Check-In Card -->
            <div class="card">
              <h3>Individual Entry</h3>
              <div
                style="
                  display: flex;
                  gap: 1rem;
                  align-items: flex-end;
                  flex-wrap: wrap;
                  margin-top: 1rem;
                "
              >
                <!-- EMPLOYEE SELECTOR -->
                <div style="flex: 1; min-width: 250px">
                  <label class="form-label">Select Employee</label>
                  <select id="att-employee-select" class="form-control">
                    <option>Loading...</option>
                  </select>
                </div>

                <!-- ADMIN/HEAD ONLY: TIME & DATE OVERRIDE -->
                <div class="admin-only" style="display: none; min-width: 150px">
                  <label class="form-label" style="color: var(--primary)"
                    >Manual Date</label
                  >
                  <input
                    type="date"
                    id="att-manual-date"
                    class="form-control"
                    style="border-color: var(--primary)"
                  />
                </div>

                <div class="admin-only" style="display: none; min-width: 130px">
                  <label class="form-label" style="color: var(--primary)"
                    >Manual Time</label
                  >
                  <input
                    type="time"
                    id="att-manual-time"
                    class="form-control"
                    style="border-color: var(--primary)"
                  />
                </div>

                <button
                  type="button"
                  onclick="handleCheckIn()"
                  class="btn btn-primary"
                >
                  Check In
                </button>
                <button
                  type="button"
                  onclick="handleCheckOut()"
                  class="btn"
                  style="
                    background: var(--bg-input);
                    color: var(--text-main);
                    border: 1px solid var(--border);
                  "
                >
                  Check Out
                </button>
              </div>
            </div>

            <!-- 2. Individual Logs Table -->
            <div class="card table-container">
              <h3>Individual Logs</h3>
              <table class="table" style="margin-top: 1rem">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Check In</th>
                    <th>Check Out</th>
                    <th>Worked Hours</th>
                  </tr>
                </thead>
                <tbody id="attendance-table-body">
                  <tr>
                    <td
                      colspan="4"
                      style="text-align: center; color: var(--text-muted)"
                    >
                      Select an employee to view logs
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- 3. NEW: Bulk Attendance Card -->
            <div class="card">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 1rem;
                "
              >
                <h3>Bulk Attendance (Today)</h3>
                <button
                  id="bulk-mark-btn"
                  class="btn btn-primary"
                  onclick="submitBulkAttendance()"
                  disabled
                >
                  Mark Present (0)
                </button>
              </div>
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th style="width: 50px; text-align: center">
                        <input
                          type="checkbox"
                          id="bulk-check-all"
                          onchange="toggleAllBulkChecks(this)"
                        />
                      </th>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Role</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="bulk-attendance-body">
                    <tr>
                      <td colspan="5" style="text-align: center">
                        Loading employees...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 4. SALARY -->
        <section id="salary" class="section">
          <div class="content-header">
            <h2>Salary Generation</h2>
          </div>
          <div class="card" style="max-width: 600px">
            <div class="form-group">
              <label class="form-label">Select Employee</label>
              <select id="salary-employee-select" class="form-control">
                <option>Loading...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Select Period</label>
              <div class="date-selector-group">
                <span class="date-icon">üìÖ</span>
                <select id="salary-month-select" style="flex: 2"></select>
                <div class="date-separator"></div>
                <select id="salary-year-select" style="flex: 1"></select>
              </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
              <button
                type="button"
                onclick="generateSalary()"
                class="btn btn-primary"
                style="flex: 1"
              >
                Generate Slip
              </button>
              <button
                type="button"
                onclick="viewSalary()"
                class="btn"
                style="
                  flex: 1;
                  background: var(--bg-input);
                  color: var(--text-main);
                  border: 1px solid var(--border);
                "
              >
                View Slip
              </button>
            </div>
          </div>
          <div id="salary-result-container" style="margin-top: 2rem"></div>
        </section>

        <!-- 5. EMPLOYEE PROFILE -->
        <section id="employee-profile" class="section">
          <div id="profile-list-view" class="card">
            <h3>Select Employee</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="profile-employee-list-body">
                <tr>
                  <td colspan="4" style="text-align: center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="profile-detail-view" style="display: none">
            <button
              onclick="backToEmployeeList()"
              class="btn"
              style="
                margin-bottom: 1rem;
                background: var(--bg-input);
                color: var(--text-main);
              "
            >
              ‚Üê Back
            </button>
            <div class="card">
              <h3>Employee Details</h3>
              <div id="profile-content-area"></div>
            </div>
            <div class="card">
              <h3>Upload Document</h3>
              <div style="display: grid; gap: 1rem">
                <select id="doc-type" class="form-control">
                  <option value="Aadhaar">Aadhaar</option>
                  <option value="PAN">PAN</option>
                  <option value="Other">Other</option>
                </select>

                <!-- Hidden Input for Custom Document Type -->
                <input
                  type="text"
                  id="doc-custom-type"
                  class="form-control"
                  placeholder="Enter Document Name (e.g. Driving License)"
                  style="display: none"
                />

                <input
                  type="text"
                  id="doc-aadhaar"
                  class="form-control"
                  placeholder="Aadhaar No"
                />

                <div>
                  <input
                    type="file"
                    id="doc-file"
                    class="form-control"
                    accept=".pdf, .jpg, .jpeg, .png"
                  />
                  <small
                    style="
                      color: var(--text-muted);
                      display: block;
                      margin-top: 5px;
                      font-size: 0.85rem;
                    "
                  >
                    Only images (.jpg, .png) or PDFs (.pdf) are allowed.
                  </small>
                </div>

                <button id="upload-doc-btn" class="btn btn-primary">
                  Upload
                </button>
              </div>
            </div>
            <div class="card">
              <h3>Documents</h3>
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th>Document No</th>
                      <th>File</th>
                      <th>Uploaded At</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="employee-docs-body">
                    <tr>
                      <td colspan="5" style="text-align: center">
                        No documents uploaded.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- 6. SETTINGS -->
        <section id="settings" class="section">
          <div class="content-header">
            <h2>System Settings</h2>
            <p>Advanced Configuration (Head/Admin Only)</p>
          </div>

          <!-- DEMO MODE TOGGLE (Head Only) -->
          <div class="card head-only" style="display: none; max-width: 500px">
            <h3 style="color: #f59e0b">Demo Configuration</h3>
            <div
              class="form-group"
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: 1rem;
              "
            >
              <label class="form-label" style="margin: 0; font-size: 1rem"
                >Enable Demo Mode Banner</label
              >
              <label class="switch">
                <input
                  type="checkbox"
                  id="setting-demo-toggle"
                  onchange="toggleDemoMode()"
                />
                <span class="slider round"></span>
              </label>
            </div>
          </div>

          <!-- SaaS Renewal (Head Only) -->
          <div
            class="card head-only"
            style="
              max-width: 500px;
              display: none;
              border: 1px solid var(--primary);
            "
          >
            <h3 style="color: var(--primary)">SaaS Subscription Renewal</h3>
            <p
              style="
                color: var(--text-muted);
                font-size: 0.9rem;
                margin-bottom: 1rem;
              "
            >
              Set the software expiration date.
            </p>
            <form onsubmit="saveRenewalDate(event)">
              <div class="form-group">
                <label class="form-label">New Expiry Date</label>
                <input
                  type="date"
                  id="setting-renewal-date"
                  class="form-control"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Renew Subscription
              </button>
            </form>
          </div>

          <div class="card" style="max-width: 500px">
            <h3>Working Hours</h3>
            <p
              style="
                color: var(--text-muted);
                font-size: 0.9rem;
                margin-bottom: 1rem;
              "
            >
              Set the daily required hours for salary calculation.
            </p>
            <form onsubmit="saveWorkingHours(event)">
              <div class="form-group">
                <label class="form-label">Hours Per Day</label>
                <input
                  type="number"
                  id="setting-hours"
                  class="form-control"
                  step="0.5"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Save Changes
              </button>
            </form>
          </div>

          <!-- BACKUP BUTTON -->
          <div class="card" style="max-width: 500px">
            <h3>Database Backup</h3>
            <p
              style="
                color: var(--text-muted);
                font-size: 0.9rem;
                margin-bottom: 1rem;
              "
            >
              Create a secure copy of the current database.
            </p>
            <button
              type="button"
              class="btn"
              style="background: var(--success); color: white; width: 100%"
              onclick="triggerDatabaseBackup()"
            >
              Create Backup Now
            </button>
          </div>

          <div class="card head-only" style="max-width: 500px; display: none">
            <h3>Add System User</h3>
            <p
              style="
                color: var(--text-muted);
                font-size: 0.9rem;
                margin-bottom: 1rem;
              "
            >
              Create new login credentials.
            </p>
            <form id="add-user-form" onsubmit="addSystemUser(event)">
              <div class="form-group">
                <label class="form-label">Username</label>
                <input
                  type="text"
                  id="new-user-name"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  id="new-user-pass"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Role</label>
                <select id="new-user-role" class="form-control">
                  <option value="user">User (Restricted)</option>
                  <option value="admin">Admin</option>
                  <option value="head">Head</option>
                </select>
              </div>
              <button type="submit" class="btn btn-warning">Create User</button>
            </form>
          </div>

          <div class="card head-only" style="display: none; margin-top: 2rem">
            <h3>User Management</h3>
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Password</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="system-users-table-body">
                  <tr>
                    <td colspan="5" style="text-align: center">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Javascript Modules (Converted to Jinja2) -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/employees.js') }}"></script>
    <script src="{{ url_for('static', filename='js/attendance.js') }}"></script>
    <script src="{{ url_for('static', filename='js/salary.js') }}"></script>
    <script src="{{ url_for('static', filename='js/employee_profile.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bulk_attendance.js') }}"></script>

    <!-- New Script -->

    <!-- Inline Dashboard Control -->
    <script>
      document.getElementById("stat-date").innerText =
        new Date().toLocaleDateString();

      // --- SIDEBAR LOGIC ---
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("active");
        document.querySelector(".sidebar-overlay").classList.toggle("active");
      }

      // Close sidebar when clicking menu item on mobile
      function switchSection(sectionId, navElement) {
        document
          .querySelectorAll(".section")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");

        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        if (navElement) navElement.classList.add("active");

        if (sectionId === "settings") loadSettings();
        if (sectionId === "attendance") loadBulkAttendanceList(); // Load Bulk Data

        // Close sidebar if on mobile
        if (window.innerWidth <= 768) {
          toggleSidebar();
        }
      }

      // --- THEME LOGIC ---
      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme");
        const next = current === "dark" ? "light" : "dark";

        html.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      }

      // --- SHUTDOWN LOGIC ---
      function exitApplication() {
        // Use custom modal if available, fallback to default confirm
        if (typeof showConfirmModal === "function") {
          showConfirmModal(
            "Are you sure you want to completely exit the HR System and shut down the server?",
            performShutdown,
          );
        } else {
          if (
            confirm(
              "Are you sure you want to completely exit the HR System and shut down the server?",
            )
          ) {
            performShutdown();
          }
        }
      }

      function performShutdown() {
        fetch("/shutdown", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              handleSuccessfulShutdown();
            } else {
              response.json().then((data) => {
                if (typeof showToast === "function") {
                  showToast("Failed to shut down: " + data.error, "error");
                } else {
                  alert("Failed to shut down: " + data.error);
                }
              });
            }
          })
          .catch((error) => {
            // A fetch error here usually means the server died instantly before responding,
            // which actually counts as a successful shutdown.
            handleSuccessfulShutdown();
          });
      }

      function handleSuccessfulShutdown() {
        // Use Toast instead of Alert for success message
        if (typeof showToast === "function") {
          showToast("Application server stopped. Closing...", "success");
        } else {
          alert("Application server stopped. The window will now close.");
        }

        // Wait 2 seconds to let the toast be seen, then close
        setTimeout(() => {
          // Attempt to close the browser tab natively
          window.close();

          // Fallback UI just in case modern browsers block window.close() for scripts
          document.body.innerHTML = `
              <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--bg-main); color:var(--text-main);">
                <h1 style="color:var(--primary);">System Offline</h1>
                <p>The HR System server has been successfully shut down.</p>
                <p>You may now safely close this browser window.</p>
              </div>
            `;
        }, 2000);
      }

      // Initialize Theme
      (function initTheme() {
        const saved = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", saved);
      })();

      function init() {
        window.updateDashboardStats = function (count) {
          document.getElementById("stat-total-emp").innerText = count;
        };

        const role = sessionStorage.getItem("role");
        document.getElementById("user-role-display").innerText = role
          ? role.toUpperCase()
          : "USER";

        if (role === "admin" || role === "head") {
          document
            .querySelectorAll(".special-access-only")
            .forEach((el) => (el.style.display = "flex"));
          document
            .querySelectorAll(".admin-only")
            .forEach((el) => (el.style.display = "block"));
        } else {
          document
            .querySelectorAll(".special-access-only")
            .forEach((el) => (el.style.display = "none"));
          document
            .querySelectorAll(".admin-only")
            .forEach((el) => (el.style.display = "none"));
        }

        if (role === "head") {
          document
            .querySelectorAll(".head-only")
            .forEach((el) => (el.style.display = "block"));
        }

        loadEmployees();
        loadDashboardEmployeeList();
      }

      init();
    </script>
  </body>
</html>
